# å®é™… S3 ç›®å½•ç»“æ„åˆ†æ

## å®é™…è§‚å¯Ÿåˆ°çš„ç›®å½•ç»“æ„

æ ¹æ®æä¾›çš„æˆªå›¾ï¼Œå®é™…çš„ S3 ç»“æ„ä¸ºï¼š

```
dataflow/
â””â”€â”€ my_flow/                    (flow åç§°ï¼Œä½¿ç”¨ä¸‹åˆ’çº¿)
    â”œâ”€â”€ my_flow_2025_12_23.py  (æ—§çš„ä»£ç æ–‡ä»¶ï¼Ÿ)
    â””â”€â”€ flow/                   (ä»£ç ç›®å½•)
        â”œâ”€â”€ main.py
        â”œâ”€â”€ config/
        â”œâ”€â”€ feature_flows/
        â”œâ”€â”€ tasks/
        â””â”€â”€ utils/
```

## Prefect Deployment é…ç½®åˆ†æ

### 1. CodeKey è·¯å¾„

å¦‚æœä¸Šä¼ æ—¶æ–‡ä»¶è·¯å¾„ä¸º `flow/main.py`ï¼ŒbasePrefix ä¸º `my_flow/`ï¼Œåˆ™ï¼š
- **å®é™… S3 Key**: `my_flow/flow/main.py` âœ…
- **Deployment path**: `my_flow/flow` âœ…
- **Entrypoint**: `main:dataset_etl_flow` âœ…

### 2. å…³é”®æ£€æŸ¥ç‚¹

#### âœ… ç›®å½•ç»“æ„æ­£ç¡®
- `flow/` ç›®å½•å­˜åœ¨
- `flow/main.py` æ–‡ä»¶å­˜åœ¨
- å­ç›®å½• `config/`, `feature_flows/`, `tasks/`, `utils/` éƒ½å­˜åœ¨

#### âš ï¸ éœ€è¦ç¡®è®¤ï¼š__init__.py æ–‡ä»¶

**å…³é”®é—®é¢˜**ï¼šå›¾ç‰‡ä¸­æ²¡æœ‰æ˜¾ç¤º `__init__.py` æ–‡ä»¶ï¼Œä½†è¿™äº›æ–‡ä»¶å¯¹äº Python åŒ…ç»“æ„è‡³å…³é‡è¦ï¼

éœ€è¦çš„ `__init__.py` æ–‡ä»¶ï¼š
- `flow/__init__.py` - **å¿…é¡»å­˜åœ¨**
- `flow/tasks/__init__.py` - **å¿…é¡»å­˜åœ¨**
- `flow/feature_flows/__init__.py` - **å¿…é¡»å­˜åœ¨**
- `flow/utils/__init__.py` - **å¿…é¡»å­˜åœ¨**

#### âš ï¸ æ½œåœ¨é—®é¢˜ï¼šæ—§æ–‡ä»¶

å­˜åœ¨ `my_flow_2025_12_23.py` æ–‡ä»¶åœ¨ `my_flow/` æ ¹ç›®å½•ä¸‹ï¼Œè¿™å¯èƒ½ï¼š
- æ˜¯æ—§ç‰ˆæœ¬çš„ä»£ç æ–‡ä»¶
- ä¸ä¼šå½±å“æ–°çš„éƒ¨ç½²ï¼ˆå› ä¸º deployment ä½¿ç”¨ `flow/main.py`ï¼‰
- ä½†å»ºè®®æ¸…ç†ä»¥é¿å…æ··æ·†

## Prefect è¯†åˆ«ä»£ç çš„æµç¨‹

### 1. Deployment é…ç½®

æ ¹æ®ä»£ç é€»è¾‘ï¼Œå½“ codeKey æ˜¯ `my_flow/flow/main.py` æ—¶ï¼š

```typescript
// backend/src/prefect/prefect.service.ts:688-694
const dir = codeKey.slice(0, codeKey.lastIndexOf('/')); // "my_flow/flow"
deploymentBody.path = "my_flow/flow";  // Prefect ä»è¿™ä¸ªè·¯å¾„ä¸‹è½½æ‰€æœ‰æ–‡ä»¶

const fileNameRaw = "main";
deploymentBody.entrypoint = "main:dataset_etl_flow";  // å…¥å£ç‚¹
```

### 2. Prefect æ‰§è¡Œæµç¨‹

1. **ä¸‹è½½ä»£ç **ï¼šPrefect ä» S3 çš„ `my_flow/flow/` è·¯å¾„ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
   - åŒ…æ‹¬ `main.py`
   - åŒ…æ‹¬æ‰€æœ‰å­ç›®å½•ï¼ˆ`config/`, `tasks/`, `feature_flows/`, `utils/`ï¼‰
   - **å¿…é¡»åŒ…æ‹¬æ‰€æœ‰ `__init__.py` æ–‡ä»¶**

2. **æ‰§è¡Œä»£ç **ï¼šPrefect åœ¨ä¸´æ—¶ç›®å½•æ‰§è¡Œ
   - å·¥ä½œç›®å½•é€šå¸¸è®¾ç½®ä¸ºä¸‹è½½çš„ç›®å½•ï¼ˆ`my_flow/flow/`ï¼‰
   - Python å¯¼å…¥ `main` æ¨¡å—
   - `main.py` ä¸­çš„ç›¸å¯¹å¯¼å…¥åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ

### 3. ç›¸å¯¹å¯¼å…¥çš„å·¥ä½œæ–¹å¼

å½“ `main.py` æ‰§è¡Œæ—¶ï¼š

```python
from .feature_flows.data_collection_flow import data_collection_flow
```

è¿™è¦æ±‚ï¼š
- `flow/` æ˜¯ä¸€ä¸ª Python åŒ…ï¼ˆéœ€è¦ `__init__.py`ï¼‰
- `feature_flows/` æ˜¯ä¸€ä¸ª Python åŒ…ï¼ˆéœ€è¦ `__init__.py`ï¼‰
- Python è·¯å¾„åŒ…å«å½“å‰æ‰§è¡Œç›®å½•

## éªŒè¯æ¸…å•

### âœ… å·²éªŒè¯
- [x] ç›®å½•ç»“æ„æ­£ç¡®ï¼š`my_flow/flow/` å­˜åœ¨
- [x] `main.py` æ–‡ä»¶å­˜åœ¨
- [x] æ‰€æœ‰å¿…è¦çš„å­ç›®å½•å­˜åœ¨ï¼ˆ`config/`, `tasks/`, `feature_flows/`, `utils/`ï¼‰

### âš ï¸ éœ€è¦éªŒè¯
- [ ] `flow/__init__.py` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] `flow/tasks/__init__.py` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] `flow/feature_flows/__init__.py` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] `flow/utils/__init__.py` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] é…ç½®æ–‡ä»¶ï¼ˆ`config/sensitive_fields.yaml`, `config/column_types.yaml`ï¼‰æ˜¯å¦å­˜åœ¨ï¼Ÿ

### ğŸ” å¦‚ä½•æ£€æŸ¥

1. **åœ¨ S3/MinIO ç®¡ç†ç•Œé¢**ï¼š
   - è¿›å…¥ `my_flow/flow/` ç›®å½•
   - æ£€æŸ¥æ˜¯å¦æœ‰ `__init__.py` æ–‡ä»¶ï¼ˆå¯èƒ½å› ä¸ºæ–‡ä»¶å¾ˆå°æˆ–åç§°ç‰¹æ®Šè€Œä¸æ˜æ˜¾ï¼‰
   - è¿›å…¥å„ä¸ªå­ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„ `__init__.py`

2. **ä½¿ç”¨ä»£ç éªŒè¯**ï¼š
   ```python
   # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
   s3_client.list_objects_v2(Bucket='dataflow', Prefix='my_flow/flow/')
   ```

3. **æµ‹è¯• Deployment**ï¼š
   - åˆ›å»ºå¹¶è¿è¡Œ deployment
   - æŸ¥çœ‹æ—¥å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ `ModuleNotFoundError`
   - å¦‚æœæœ‰å¯¼å…¥é”™è¯¯ï¼Œè¯´æ˜ç¼ºå°‘ `__init__.py` æ–‡ä»¶

## ç»“è®ºå’Œå»ºè®®

### ç›®å½•ç»“æ„è¯„ä¼°ï¼šâœ… **åŸºæœ¬æ­£ç¡®**

å½“å‰ç›®å½•ç»“æ„ç¬¦åˆé¢„æœŸï¼Œä½†éœ€è¦ç¡®è®¤ï¼š

1. **æ‰€æœ‰ `__init__.py` æ–‡ä»¶éƒ½å·²ä¸Šä¼ **
   - è¿™æ˜¯ Python åŒ…ç»“æ„çš„å…³é”®
   - å¦‚æœç¼ºå¤±ï¼Œç›¸å¯¹å¯¼å…¥ä¼šå¤±è´¥

2. **é…ç½®æ–‡ä»¶è·¯å¾„**
   - é…ç½®æ–‡ä»¶è·¯å¾„åº”è¯¥ä» `my_flow/flow/config/` è¯»å–
   - éœ€è¦ç¡®è®¤ `config/` ç›®å½•ä¸‹æœ‰ `sensitive_fields.yaml` å’Œ `column_types.yaml`

3. **å»ºè®®çš„éªŒè¯æ­¥éª¤**ï¼š
   - åœ¨ S3 ç®¡ç†ç•Œé¢è¯¦ç»†æ£€æŸ¥æ‰€æœ‰ `__init__.py` æ–‡ä»¶
   - æˆ–è€…ç›´æ¥æµ‹è¯• deploymentï¼ŒæŸ¥çœ‹è¿è¡Œæ—¥å¿—
   - å¦‚æœæœ‰å¯¼å…¥é”™è¯¯ï¼Œè¡¥å……ç¼ºå¤±çš„ `__init__.py` æ–‡ä»¶

### å¦‚æœé‡åˆ°é—®é¢˜

å¦‚æœ Prefect æ— æ³•è¯†åˆ«ä»£ç ï¼Œå¸¸è§åŸå› ï¼š

1. **ç¼ºå°‘ `__init__.py`** â†’ è¡¥å……æ‰€æœ‰å¿…è¦çš„ `__init__.py` æ–‡ä»¶
2. **Entrypoint é”™è¯¯** â†’ æ£€æŸ¥ deployment é…ç½®ä¸­çš„ entrypoint
3. **è·¯å¾„ä¸åŒ¹é…** â†’ ç¡®è®¤ deployment çš„ `path` é…ç½®ä¸ S3 è·¯å¾„ä¸€è‡´

